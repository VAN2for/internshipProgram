<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="copyright" content="playsmart" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,user-scalable=no" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="libProject" />
    <meta name="template-version" content="{{template-version}}" />

    <link rel="shortcut icon" href="../lib/imgs/qici.ico" />
    <title>Preview WebGL</title>
    <style>
        html,
        body {
          padding: 0;
          margin: 0;
          width: 100%;
          height: 100%;
        }
    </style>
    <script>
      var qici = {};
      qici.config = {
        isEcPlus: true,
        // 游戏名字，默认为：未命名
        gameName: "libProject",

        // 本地存储标志符，默认为：com.DefaultCompany.Game
        localStorageID: "com.qcplay.demo.dota",

        // 游戏示例，将作为全局变量访问，默认为：game
        gameInstance: "qc_game",

        // 帧率
        frameRate: { mobile: 60, desktop: 60 },

        // 固定游戏大小
        fixedGameSize: { enabled: false, width: 640, height: 960 },

        // 分辨率清晰度
        resolutionRatio: 0.25,

        // 游戏背景色
        backgroundColor: 4282861383,

        // 后台运行
        runInBackground: true,

        // 启用多语言系统
        useLanguages: true,

        // 抗锯齿
        antialias: true,

        // 渲染方式
        renderer: "Auto",

        // 背景透明
        transparent: true,

        // 游戏切屏时的进度界面
        loadingPrefab: "",

        // 开发模式
        developerMode: true,

        // 是否启用脏矩形
        dirtyRectangles: false,

        // 是否显示脏矩形区域
        dirtyRectanglesShow: false,

        // 自定义配置
        customSettings: {},

        // 所有的游戏场景
        scene: ["Temp/scene_editor", "resource/scene/gamePlay"],

        // 入口场景
        entryScene: "Temp/scene_editor",
        loadingHandler: "progressHandler",
        loading: {
          loadingText: "Loading, please wait...",
          loadingInterval: 200,
          brightingInterval: 10,
          blinkingCount: 5,
          blinkingInterval: 70,
          fadingInInterval: 50,
          fadingOutInterval: 100,
        },
      };
      qici.config.renderer = "__RENDERER__";
      qici.config.developerMode = true;
      qici.config.preview = true;
      qici.config.remoteLogUrl = window.location.origin;

      function initResizableGameSize() {
        var game = window[qici.config.gameInstance];
        if (game.fixedGameSize) {
          game.phaser.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
        } else {
          game.phaser.scale.scaleMode = Phaser.ScaleManager.NO_SCALE;
        }

        var gameDiv = document.getElementById("gameDiv"),
          width = document.documentElement.clientWidth,
          height =
            Math.min(
              window.innerHeight,
              document.documentElement.clientHeight
            ) || document.documentElement.clientHeight;

        // gameDiv.style.left = '30px';
        // gameDiv.style.top = '30px';
        gameDiv.style.width = width + "px";
        gameDiv.style.height = height + "px";

        var dragDiv = document.getElementById("dragDiv");
        dragDiv.style.display = "none";

        dragDiv.style.msTouchAction = "none";
        dragDiv.style.setProperty(
          "-webkit-tap-highlight-color",
          "rgba(0, 0, 0, 0)",
          null
        );
        dragDiv.style.width = "60px";
        dragDiv.style.height = "60px";
        dragDiv.style.borderRadius = "30px";
        dragDiv.style.background = "rgba(128,128,128,0.5)";
        dragDiv.style.cursor = "pointer";
        dragDiv.style.left = width + "px";
        dragDiv.style.top = height + "px";

        var lastClientPoint = null,
          lastWidth = null,
          lastHeight = null;

        function getClientPoint(event) {
          return {
            x: event.clientX,
            y: event.clientY,
          };
        }

        function handleDown(event) {
          event.preventDefault();
          if (game.paused) {
            return;
          }
          lastClientPoint = getClientPoint(event);
          lastWidth = width;
          lastHeight = height;
        }

        function handleMove(event) {
          if (event.target === dragDiv) {
            dragDiv.style.background = "rgba(128,128,128,0.8)";
          } else {
            dragDiv.style.background = "rgba(128,128,128,0.5)";
          }
          if (lastClientPoint) {
            var clientPoint = getClientPoint(event),
              dx = clientPoint.x - lastClientPoint.x,
              dy = clientPoint.y - lastClientPoint.y;

            width = lastWidth + dx;
            height = lastHeight + dy;

            resizeGameSize();
          }
        }

        function handleUp(event) {
          lastClientPoint = null;
          dragDiv.style.background = "rgba(128,128,128,0.5)";
        }

        function resizeGameSize() {
          gameDiv.style.width = width + "px";
          gameDiv.style.height = height + "px";
          dragDiv.style.left = width + "px";
          dragDiv.style.top = height + "px";
          game.setGameSize(width, height);
          game.world && game.world.updateDomRoot();
        }

        dragDiv.addEventListener("mousedown", handleDown, false);
        dragDiv.addEventListener("touchstart", handleDown, false);

        window.addEventListener("mousemove", handleMove, false);
        window.addEventListener("touchmove", handleMove, false);

        window.addEventListener("mouseup", handleUp, false);
        window.addEventListener("touchend", handleUp, false);

        var updateGameLayout = game.updateGameLayout;
        game.updateGameLayout = function (force) {
          if (force) {
            resizeGameSize();
          }
          updateGameLayout.call(game, force);
        };
        game.updateGameLayout();
      }

        __PLUGIN_VARIABLES__

        qici.scripts = [
            __URLMAP_SCRIPTS__
            '../lib/phaser.js',
            '../lib/webfontloader.js',
            '../lib/qc-core-debug.js',
            '../lib/PlaySmartEditorData.js',
            // sound duration
            __SOUND_DURATION__
            // asset count
            __ASSET_COUNT__
            // External scripts for plugins
            __EXTERNAL_PLUGINS_SCRIPTS__
            // Plugins scripts
            __PLUGINS_SCRIPTS__
            // User scripts
            __USER_SCRIPTS__
        ];

        // Asset count that need preload in boot
        qici.loadingAssetCount = __LOADING_ASSET_COUNT__;
        function resizeGameSize() {
            var game = window[qici.config.gameInstance];
            if (!game) return;
            gameDiv.style.width = window.innerWidth + "px";
            gameDiv.style.height = window.innerHeight + "px";
            game.setGameSize(window.innerWidth, window.innerHeight);
            game.world && game.world.updateDomRoot();
        }
        window.addEventListener("resize", function () {
            resizeGameSize();
        });
        window.gameReady = function () {
            parent && parent.postMessage("scene-game-ready", "*");
            
            function __getQueryString(name) {
              var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
              var r = window.location.search.substr(1).match(reg);
              if (r != null) return decodeURIComponent(r[2]);
              return null;
            }
            ps.mainState.add("gameStart", function () {
              // 保证在游戏自身优先切换场景（同步）
              // 然后异步做自己要的场景切换
              setTimeout(function () {
                var sceneUUID = __getQueryString("scene");

                if (sceneUUID) {
                    var qcDom = UIRoot.getChild("gamePlay");
                    var scenes = qcDom ? qcDom.children : [];
                    scenes.forEach(function (scene) {
                        scene.visible = scene.uuid === sceneUUID;
                        console.log(scene.uuid, scene.visible);
                    });
                    // 通知场景变化来触发动画
                    ps.mainState.dispatch(ps.GameState.SCENECHANGE, sceneUUID);
                }
              });
            });
        };
    </script>
</head>

<body onload="qici.init();" bgcolor="#000000">
    <div
      style="overflow: hidden; padding: 0; margin: 0; width: 100%; height: 100%"
    >
      <div id="dragDiv" style="position: absolute"></div>
      <div id="gameDiv" style="position: absolute"></div>
    </div>
    <script src="../lib/LAB.js"></script>
    <script src="../lib/qc-loading-debug.js"></script>
    <script src="../lib/qc-loading-editor.js"></script>
    <script src="../lib/expand/languagesMgr/languagesMgr.js"></script>
    <script type="text/javascript">
      window.alert = function (msg) {
        console.error(msg);
      };
    </script>
  </body>
</html>
